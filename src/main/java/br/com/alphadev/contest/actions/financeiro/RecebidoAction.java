package br.com.alphadev.contest.actions.financeiro;import java.util.ArrayList;import java.util.Collection;import java.util.Date;import java.util.List;import org.mentawai.authorization.Authorizable;import org.mentawai.core.BaseAction;import br.com.alphadev.annotations.ActionClass;import br.com.alphadev.annotations.ConsequenceOutput;import br.com.alphadev.annotations.Consequences;import br.com.alphadev.contest.KGlobal;import br.com.alphadev.contest.KGlobal.TipoPesquisaReceber;import br.com.alphadev.contest.entity.Recebido;import br.com.alphadev.contest.entity.valueObject.FormaPagamento;import br.com.alphadev.contest.filters.VendaFilter;import br.com.alphadev.core.ServicesFactory;import br.com.alphadev.util.ConfigHelper;import br.com.alphadev.util.Log4jWrapper;import br.com.alphadev.util.UsuarioLogadoWrapper;/** * @author Andre Penteado * @since 14/11/2007 - 17:50:16 */@ActionClass(prefix = "/financeiro/recebido")public class RecebidoAction extends BaseAction implements Authorizable {    private Log4jWrapper log = new Log4jWrapper(RecebidoAction.class, null);    private void instanciarServicos(UsuarioLogadoWrapper userLogin) {        try {            log = new Log4jWrapper(RecebidoAction.class, userLogin);        }        catch (Exception ex) {            log.fatal("AÇÕES NÃO INSTANCIADAS: ".concat(RecebidoAction.class.getName()), ex);        }    }    @SuppressWarnings("rawtypes")    @Override    public boolean authorize(String innerAction, Object user, List groups) {        if (user == null || groups == null)            return false;        instanciarServicos((UsuarioLogadoWrapper)user);        if (groups.indexOf(KGlobal.CATEGORIA_SUPERUSUARIO) != -1 || groups.indexOf(KGlobal.CATEGORIA_FINANCEIRO) != -1)            return true;        return false;    }    @Consequences(outputs = @ConsequenceOutput(page = "/financeiro/recebido/pesquisar.jsp"))    public String pesquisar() {        try {            Date emissaoInicial = input.getDate("txt_emissao_inicial", "dd/MM/yyyy");            Date emissaoFinal = input.getDate("txt_emissao_final", "dd/MM/yyyy");            Date vencimentoInicial = input.getDate("txt_vencimento_inicial", "dd/MM/yyyy");            Date vencimentoFinal = input.getDate("txt_vencimento_final", "dd/MM/yyyy");            int[] idsTiposConta = input.getInts("chk_tipos_conta");            long idCliente = input.getLong("txt_id_cliente");            long numero = input.getLong("txt_numero");            VendaFilter<Recebido> filter = ServicesFactory.getInstance(VendaFilter.class, Recebido.class);            Collection<Recebido> listaRecebido = new ArrayList<Recebido>();            if (input.getString(TipoPesquisaReceber.NUMERO.name()) != null && input.getString(TipoPesquisaReceber.NUMERO.name()).length() > 0) {                filter.setNumeroVenda(numero);                listaRecebido = filter.executeFilter();                output.setValue("tabName", TipoPesquisaReceber.NUMERO);            }            else if (input.getString(TipoPesquisaReceber.CLIENTE.name()) != null && input.getString(TipoPesquisaReceber.CLIENTE.name()).length() > 0) {                filter.setIdCliente(idCliente);                listaRecebido = filter.executeFilter();                output.setValue("tabName", TipoPesquisaReceber.CLIENTE);            }            else if (input.getString(TipoPesquisaReceber.EMISSAO.name()) != null && input.getString(TipoPesquisaReceber.EMISSAO.name()).length() > 0) {                filter.setDataEmissaoInicial(emissaoInicial);                filter.setDataEmissaoFinal(emissaoFinal);                listaRecebido = filter.executeFilter();                output.setValue("tabName", TipoPesquisaReceber.EMISSAO);            }            else if (input.getString(TipoPesquisaReceber.VENCIMENTO.name()) != null && input.getString(TipoPesquisaReceber.VENCIMENTO.name()).length() > 0) {                filter.setDataVencimentoInicial(vencimentoInicial);                filter.setDataVencimentoFinal(vencimentoFinal);                listaRecebido = filter.executeFilter();                output.setValue("tabName", TipoPesquisaReceber.VENCIMENTO);            }            else if (input.getString(TipoPesquisaReceber.TIPO_CONTA.name()) != null && input.getString(TipoPesquisaReceber.TIPO_CONTA.name()).length() > 0) {                filter.setIdsTiposConta(idsTiposConta);                listaRecebido = filter.executeFilter();                output.setValue("tabName", TipoPesquisaReceber.TIPO_CONTA);            }            output.setValue("listaRecebido", listaRecebido);            // Colunas do relatório            String[] colunas = input.getStrings("chk_colunas_pesquisa");            if (colunas != null && colunas.length > 0)                for (String col : colunas)                    output.setValue(col, '1');        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);            return ERROR;        }        return SUCCESS;    }    @Consequences(outputs = @ConsequenceOutput(page = "/financeiro/recebido/cadastro.jsp"))    public String cadastro() {        try {            Recebido recebido = new Recebido(input.getLong("txt_id"));            output.setValue("recebido", recebido);        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);            return ERROR;        }        return SUCCESS;    }    @Consequences(outputs = { @ConsequenceOutput(result = SUCCESS, page = "/comum/mensagem.jsp"),                    @ConsequenceOutput(result = ERROR, page = "/financeiro/recebido/cadastro.jsp") })    public String gravar() {        try {            Recebido recebido = new Recebido(input.getLong("hid_id"));            recebido.getReceber().setNumeroDocumento(input.getString("txt_numero_documento"));            recebido.getReceber().setObservacao(input.getString("txt_observacao_parcela"));            recebido.setFormaPagamento(FormaPagamento.valueOf(input.getString("cbo_forma_pagamento")));            recebido.setDataPagamento(input.getDate("txt_data_recebimento", "dd/MM/yyyy"));            recebido.setObservacao(input.getString("txt_observacao"));            try {                if (!"".equals(input.getString("txt_valor_recebido")))                    recebido.setValorPago(new Double(input.getString("txt_valor_recebido").replace(".", "").replace(",", ".")));            }            catch (Exception ex) {                addError("txt_valor_recebido", ConfigHelper.getProperty("error.invalid", "Valor Recebido"));                return ERROR;            }            recebido.gravar();        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);            return ERROR;        }        output.setValue("titulo", "Recebimento");        output.setValue("mensagem", ConfigHelper.getProperty("info.saveOk", "Recebimento"));        output.setValue("url", input.getProperty("contextPath") + "/financeiro/recebido.pesquisar.action");        return SUCCESS;    }    @Consequences(outputs = @ConsequenceOutput(page = "/financeiro/recebido/pesquisar.jsp"))    public String estornar() {        try {            Recebido recebido = new Recebido(input.getLong("txt_id"));            recebido.excluir();        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);            return ERROR;        }        return SUCCESS;    }}