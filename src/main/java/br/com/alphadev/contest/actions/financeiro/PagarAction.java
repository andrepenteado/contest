package br.com.alphadev.contest.actions.financeiro;import java.util.ArrayList;import java.util.Collection;import java.util.Date;import java.util.List;import org.mentawai.authorization.Authorizable;import org.mentawai.core.BaseAction;import org.mentawai.rule.RequiredFieldRule;import org.mentawai.validation.Validatable;import org.mentawai.validation.Validator;import br.com.alphadev.annotations.ActionClass;import br.com.alphadev.annotations.ConsequenceOutput;import br.com.alphadev.annotations.Consequences;import br.com.alphadev.contest.KGlobal;import br.com.alphadev.contest.KGlobal.TipoPesquisaPagar;import br.com.alphadev.contest.entity.Pagar;import br.com.alphadev.contest.entity.Pago;import br.com.alphadev.contest.entity.TipoConta;import br.com.alphadev.contest.entity.valueObject.FormaPagamento;import br.com.alphadev.contest.filters.CompraFilter;import br.com.alphadev.core.ServicesFactory;import br.com.alphadev.util.ConfigHelper;import br.com.alphadev.util.Log4jWrapper;import br.com.alphadev.util.UsuarioLogadoWrapper;/** * @author Andre Penteado * @since 14/11/2007 - 17:50:16 */@ActionClass(prefix = "/financeiro/pagar")public class PagarAction extends BaseAction implements Authorizable, Validatable {    private Log4jWrapper log = new Log4jWrapper(PagarAction.class, null);    private void instanciarServicos(UsuarioLogadoWrapper userLogin) {        try {            log = new Log4jWrapper(PagarAction.class, userLogin);        }        catch (Exception ex) {            log.fatal("AÇÕES NÃO INSTANCIADAS: ".concat(PagarAction.class.getName()), ex);        }    }    @SuppressWarnings("rawtypes")    @Override    public boolean authorize(String innerAction, Object user, List groups) {        if (user == null || groups == null)            return false;        instanciarServicos((UsuarioLogadoWrapper)user);        if (groups.indexOf(KGlobal.CATEGORIA_SUPERUSUARIO) != -1 || groups.indexOf(KGlobal.CATEGORIA_FINANCEIRO) != -1)            return true;        return false;    }    @Override    public void prepareValidator(Validator validator, String innerAction) {        if (innerAction.equals("gravar")) {            validator.add("txt_valor", new RequiredFieldRule(), ConfigHelper.getProperty("error.required", "Valor"));        }    }    @Consequences(outputs = @ConsequenceOutput(page = "/financeiro/pagar/pesquisar.jsp"))    public String pesquisar() {        try {            Date emissaoInicial = input.getDate("txt_emissao_inicial", "dd/MM/yyyy");            Date emissaoFinal = input.getDate("txt_emissao_final", "dd/MM/yyyy");            Date vencimentoInicial = input.getDate("txt_vencimento_inicial", "dd/MM/yyyy");            Date vencimentoFinal = input.getDate("txt_vencimento_final", "dd/MM/yyyy");            int[] idsTiposConta = input.getInts("chk_tipos_conta");            long idFornecedor = input.getLong("txt_id_fornecedor");            long numero = input.getLong("txt_numero");            CompraFilter<Pagar> filter = ServicesFactory.getInstance(CompraFilter.class, Pagar.class);            Collection<Pagar> listaPagar = new ArrayList<Pagar>();            if (input.getString(TipoPesquisaPagar.NUMERO.name()) != null && input.getString(TipoPesquisaPagar.NUMERO.name()).length() > 0) {                filter.setNumeroCompra(numero);                listaPagar = filter.executeFilter();                output.setValue("tabName", TipoPesquisaPagar.NUMERO);            }            else if (input.getString(TipoPesquisaPagar.FORNECEDOR.name()) != null && input.getString(TipoPesquisaPagar.FORNECEDOR.name()).length() > 0) {                filter.setIdFornecedor(idFornecedor);                listaPagar = filter.executeFilter();                output.setValue("tabName", TipoPesquisaPagar.FORNECEDOR);            }            else if (input.getString(TipoPesquisaPagar.EMISSAO.name()) != null && input.getString(TipoPesquisaPagar.EMISSAO.name()).length() > 0) {                filter.setDataEmissaoInicial(emissaoInicial);                filter.setDataEmissaoFinal(emissaoFinal);                listaPagar = filter.executeFilter();                output.setValue("tabName", TipoPesquisaPagar.EMISSAO);            }            else if (input.getString(TipoPesquisaPagar.VENCIMENTO.name()) != null && input.getString(TipoPesquisaPagar.VENCIMENTO.name()).length() > 0) {                filter.setDataVencimentoInicial(vencimentoInicial);                filter.setDataVencimentoFinal(vencimentoFinal);                listaPagar = filter.executeFilter();                output.setValue("tabName", TipoPesquisaPagar.EMISSAO);            }            else if (input.getString(TipoPesquisaPagar.TIPO_CONTA.name()) != null && input.getString(TipoPesquisaPagar.TIPO_CONTA.name()).length() > 0) {                filter.setIdsTiposConta(idsTiposConta);                listaPagar = filter.executeFilter();                output.setValue("tabName", TipoPesquisaPagar.TIPO_CONTA);            }            else {                // Listar contas em aberto                listaPagar = filter.executeFilter();            }            output.setValue("listaPagar", listaPagar);        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);            return ERROR;        }        return SUCCESS;    }    @Consequences(outputs = @ConsequenceOutput(page = "/financeiro/pagar/cadastro.jsp"))    public String cadastro() {        try {            Pagar pagar = new Pagar(input.getLong("txt_id"));            output.setValue("pagar", pagar);        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);            return ERROR;        }        return SUCCESS;    }    @Consequences(outputs = { @ConsequenceOutput(result = SUCCESS, page = "/comum/mensagem.jsp"),                    @ConsequenceOutput(result = ERROR, page = "/financeiro/pagar/cadastro.jsp") })    public String gravar() {        try {            Pagar pagar = new Pagar(input.getLong("hid_id"));            if (pagar.getPagamentos() == null)                pagar.setPagamentos(new ArrayList<Pago>());            if (!"".equals(input.getString("txt_descricao")))                pagar.setDescricao(input.getString("txt_descricao"));            TipoConta tipoConta = new TipoConta(input.getLong("cbo_tipo_conta"));            pagar.setTipoConta(tipoConta.getId() != null ? tipoConta : null);            pagar.setVencimento(input.getDate("txt_vencimento", "dd/MM/yyyy"));            try {                if (!"".equals(input.getString("txt_valor")))                    pagar.setValor(new Double(input.getString("txt_valor").replace(".", "").replace(",", ".")));            }            catch (Exception ex) {                addError("txt_valor", ConfigHelper.getProperty("error.invalid", "Valor"));                return ERROR;            }            pagar.gravar();        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);            return ERROR;        }        output.setValue("titulo", "Contas a Pagar");        output.setValue("mensagem", ConfigHelper.getProperty("info.saveOk", "Conta a Pagar"));        output.setValue("url", input.getProperty("contextPath") + "/financeiro/pagar.pesquisar.action");        return SUCCESS;    }    @Consequences(outputs = @ConsequenceOutput(page = "/financeiro/pagar/baixar.jsp"))    public String darBaixa() {        try {            Pagar pagar = new Pagar(input.getLong("txt_id"));            output.setValue("pagar", pagar);        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);        }        return SUCCESS;    }    @Consequences(outputs = { @ConsequenceOutput(result = SUCCESS, page = "/comum/mensagem.jsp"),                    @ConsequenceOutput(result = ERROR, page = "/financeiro/pagar/baixar.jsp") })    public String baixar() {        try {            Pagar pagar = new Pagar(input.getLong("hid_id"));            if (pagar.getPagamentos() == null)                pagar.setPagamentos(new ArrayList<Pago>());            Pago pago = new Pago();            pago.setPagar(pagar);            pago.setFormaPagamento(FormaPagamento.valueOf(input.getString("cbo_forma_pagamento")));            pago.setDataPagamento(input.getDate("txt_data_pagamento", "dd/MM/yyyy"));            try {                if (!"".equals(input.getString("txt_valor_pago")))                    pago.setValorPago(new Double(input.getString("txt_valor_pago").replace(".", "").replace(",", ".")));            }            catch (Exception ex) {                addError("txt_valor_pago", ConfigHelper.getProperty("error.invalid", "Valor Pago"));                return ERROR;            }            pago.gravar();        }        catch (Exception ex) {            addError(ConfigHelper.get().getString("error.general"));            log.error(ConfigHelper.get().getString("error.general"), ex);            return ERROR;        }        output.setValue("titulo", "Contas Paga");        output.setValue("mensagem", ConfigHelper.getProperty("info.saveOk", "Conta Paga"));        output.setValue("url", input.getProperty("contextPath") + "/financeiro/pagar.pesquisar.action");        return SUCCESS;    }}